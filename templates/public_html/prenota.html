{% extends "base.html" %}

{% block title %}
{% if user %}
Home - {{ user }}
{% else %}
Home
{% endif %}
{% endblock title %}

{% block extra_css %}

{% endblock extra_css %}

{% block extra_jquery %}

    <style>
        .seat-row {
            display: flex;
            justify-content: center;
            margin-bottom: 5px;
        }
        .seat {
            width: 35px;
            height: 35px;
            margin: 3px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            color: white;
        }
        .seat.free { background-color: #0d6efd; }
        .seat.occupied { background-color: #6c757d; cursor: not-allowed; }
        .seat.selected { background-color: #ffc107; color: black; border: 2px solid red; }

    </style>

    <script>


        let PrenotaClass = function(){

            const cabins =  ["FirstClass", "Business", "Economy"]


            const fakeData = {
                andata: [
                    { route: "Milano → Roma",  },
                    { route: "Roma → New York"}
                ],
                ritorno: [
                    { route: "New York → Parigi"},
                    { route: "Parigi → Milano"}
                ]
            };
            const seatPrices = { "First Class": 200, "Business Class": 150, "Economy Class": 100 };

            let params;
            let id_andata;
            let id_ritorno;
            let quantity;
            let seq_ritorno;
            let seq_andata;
            let selectedSeats = [];

            function loadData(){
                let data_ = null;
                jQuery.ajax({
                    url: ajaxUrl + '?fun=voli&oper=getAllSequenceByViaggio',
                    type: 'POST',
                    data: {
                        id_andata:id_andata,
                        id_ritorno:id_ritorno,
                        seq_andata:seq_andata,
                        seq_ritorno:seq_ritorno
                    },
                    dataType: "json",
                    async: false,
                    success: function (data) {

                        var parsedResult = checkAjaxResponse(data, false);
                        if (!parsedResult) {

                            data_ = data;

                        }
                    }
                });

                return data_;
            }

            // Disegna tabs per gli scali
            function drawRouteTabs(travelType, routes) {

                if(routes)
                {
                    const tabs = $("#" + travelType + "Tabs");
                    const content = $("#" + travelType + "Content");

                    tabs.empty();
                    content.empty();

                    for(let i = 0; i < routes.length;++i)
                    {
                        let route = routes[i];
                        let tab_id = travelType + "-route-" + route.id_volo;

                        tabs.append(`
                            <li class="nav-item" role="presentation">
                              <button class="nav-link ${route.sequence_identifier === 1 ? "active" : ""}" id="${tab_id}-tab"
                                      data-bs-toggle="tab" data-bs-target="#${tab_id}" type="button" role="tab">
                                ${route.aereoporto_partenza_rel.citta} -> ${route.aereoporto_arrivo_rel.citta}
                              </button>
                            </li>
                          `);

                        content.append(`
                            <div class="tab-pane fade ${route.sequence_identifier === 1 ? "show active" : ""}" id="${tab_id}" role="tabpanel">
                              <div id="seatMap-${tab_id}"></div>
                            </div>
                          `);

                        drawSeatMap(
                            cabins,
                            $("#seatMap-" + tab_id),
                            travelType,
                            `${route.aereoporto_partenza_rel.citta} -> ${route.aereoporto_arrivo_rel.citta}`,
                            {
                                "First Class": [route.seat_row_number_first,route.seat_column_number_first],
                                "Business Class": [route.seat_row_number_business,route.seat_column_number_business],
                                "Economy Class": [route.seat_row_number_economy,route.seat_column_number_economy]
                            },
                            route.seats
                        )
                    }
                }

            }

            // Disegna mappa dei posti (accordion per cabine)
            function drawSeatMap(cabins, seatMap, travelType, route,map,seats) {

                let last_class_seen = null;
                let accordition_to_append = "";
                let row_to_append = "";
                let column_to_append = "";
                let idx = `${route.replace(/\s/g, '')}_${last_class_seen}`;

                for(let i = 0; i < seats.length;i++)
                {
                    if(last_class_seen != seats[i].seat_class)
                    {
                        last_class_seen = seats[i].seat_class;
                        idx = `${route.replace(/\s/g, '')}_${last_class_seen}`;

                        seatMap.append(`
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseOne" aria-expanded="true" aria-controls="panelsStayOpen-collapseOne">
                                        ${route}
                                      </button>
                                    </h2>
                                    <div id="panelsStayOpen-collapseOne" class="accordion-collapse collapse show">
                                      <div class="accordion-body" id="${route.replace(/\s/g, '')}_${last_class_seen}_seats">
                                       </div>
                                    </div>`);
                        accordition_to_append = $(`#${idx}_seat`);
                    }

                    // ex 0 means seat_row_number_first
                    // ex 1 means seat_col_number_first

                    if(i%seats[last_class_seen][0] === 0){
                        accordition_to_append.append(`
                            <div class="d-flex row" id="${idx}_row_${i}">
                                <div class="col-5" id="${idx}_row_${i}_col_1"></div>
                                <div class="col-2">||</div>
                                <div class="col-5" id="${idx}_row_${i}_col_2"></div>
                            </div>
                        `);

                        row_to_append = `${idx}_row_${i}`;
                    }

                    if (i%seats[last_class_seen][1] > (i%seats[last_class_seen][1])/2)
                    {

                    }





                }

            }

            // Aggiorna riepilogo
            function updateSummary() {
                $("#quantita").text(selectedSeats.length);
                $("#selectedSeatDisplay").text(selectedSeats.map(s => `${s.route} [${s.row}${s.col}]`).join(", ") || "-");
                let total = selectedSeats.reduce((sum, s) => sum + s.price, 0);
                $("#totalPriceDisplay").text(total + " €");
            }

            return {
                init(){

                    params = new URLSearchParams(window.location.search);
                    id_andata = params.get("id_andata");
                    id_ritorno = params.get("id_ritorno");
                    quantity = params.get("quantita");
                    seq_andata = params.get("seq_andata");
                    seq_ritorno = params.get("seq_ritorno");

                    let data = loadData();

                    drawRouteTabs("andata", data.andata);

                    drawRouteTabs("ritorno", data.ritorno);

                }

            }
        }();

        // Fake data



        // Inizializza pagina
        $(function() {
            PrenotaClass.init();
        });
    </script>

</script>
{% endblock extra_jquery %}

{% block main_content %}

    <div class="container py-4">

        <!-- Tabs principali Andata/Ritorno -->
        <ul class="nav nav-tabs" id="tripTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="andata-tab" data-bs-toggle="tab" data-bs-target="#andata" type="button" role="tab">
                    Andata
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ritorno-tab" data-bs-toggle="tab" data-bs-target="#ritorno" type="button" role="tab">
                    Ritorno
                </button>
            </li>
        </ul>

        <div class="tab-content mt-3">
            <!-- ANDATA -->
            <div class="tab-pane fade show active" id="andata" role="tabpanel">
                <ul class="nav nav-tabs" id="andataTabs" role="tablist"></ul>
                <div class="tab-content mt-3" id="andataContent"></div>
            </div>

            <!-- RITORNO -->
            <div class="tab-pane fade" id="ritorno" role="tabpanel">
                <ul class="nav nav-tabs" id="ritornoTabs" role="tablist"></ul>
                <div class="tab-content mt-3" id="ritornoContent"></div>
            </div>
        </div>

        <!-- Riepilogo -->
        <div class="card shadow-sm mt-4">
            <div class="card-body">
                <h5 class="text-primary mb-3">Riepilogo</h5>
                <div class="row">
                    <div class="col-md-4">
                        <small>Biglietti</small>
                        <div id="quantita" class="h6">0</div>
                    </div>
                    <div class="col-md-4">
                        <small>Posti Selezionati</small>
                        <div id="selectedSeatDisplay" class="h6 text-success">-</div>
                    </div>
                    <div class="col-md-4">
                        <small>Totale</small>
                        <div id="totalPriceDisplay" class="h5 text-warning">0 €</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock main_content %}