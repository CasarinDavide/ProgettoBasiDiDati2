{% extends "base.html" %}

{% block title %}
{% if user %}
Home - {{ user }}
{% else %}
Home
{% endif %}
{% endblock title %}

{% block extra_css %}

{% endblock extra_css %}

{% block extra_jquery %}

<style>
    .accordion-button.economy {
        background-color: #4caf50;
        /* Green */
        color: white;
    }

    .accordion-button.business {
        background-color: #f44336;
        /* Red */
        color: white;
    }

    .accordion-button.first {
        background-color: #2196f3;
        /* Blue */
        color: black;
    }

    /* Seat map background */
    .accordion-body {
        background-color: #f5f5f5;
    }

    /* Seat improvements */
    .seat-row {
        width: 100%;
    }

    .seat-group {
        display: flex;
        gap: 5px;
    }

    .aisle {
        width: 20px;
    }

    .seat {
        width: 35px;
        height: 35px;
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.85rem;
        cursor: pointer;
        border: 1px solid #ccc;
        transition: 0.2s all;
    }

    .seat.free {
        background-color: #e0f7fa;
    }

    .seat.occupied {
        background-color: #b0bec5;
        cursor: not-allowed;
    }

    .seat.selected {
        background-color: #4db6ac;
        color: white;
    }

    .seat-row {
        width: 100%;
    }

    .seat-group {
        display: flex;
        gap: 5px;
        /* space between seats */
    }

    .aisle {
        width: 20px;
        /* narrow aisle */
    }

    .seat {
      border: 1px solid #ccc;
      border-radius: 6px;
      margin: 4px;
      min-width: 50px;
      min-height: 50px;
      cursor: pointer;
      transition: transform 0.2s ease, background-color 0.2s ease;
    }

    .seat.free {
        background-color: #e0f7fa;
    }

    .seat.occupied {
        background-color: #b0bec5;
        cursor: not-allowed;
    }

    .seat.selected {
        background-color: #4db6ac;
        color: white;
    }
</style>

<script>
    let clearModal = function() {
        $('#nominativiContainer').empty();
    }

    let PrenotaClass = function () {

        const cabins = ["FirstClass", "Business", "Economy"]

        let params;
        let id_andata;
        let id_ritorno;
        let quantity;
        let seq_ritorno;
        let seq_andata;
        let selectedSeats = [];
        let voli_data;
        let viaggio_local_data;
        let unique_tratte = {}
        
        
        function getViaggioData() {
            viaggio_local_data = null;
            jQuery.ajax({
                url: ajaxUrl + '?fun=viaggi&oper=get_andata_ritorno',
                type: 'POST',
                data: {
                    id_andata: id_andata,
                    id_ritorno: id_ritorno
                },
                dataType: "json",
                async: false,
                success: function (data) {

                    var parsedResult = checkAjaxResponse(data, false);
                    if (!parsedResult) {

                        viaggio_local_data = data;

                        $('#scontoAndataDisplay').text(`${data['andata'].sconto_biglietto} %`);
                        $('#scontoRitornoDisplay').text(`${data['ritorno']?data['ritorno'].sconto_biglietto:'-'} %`);


                    }
                }
            });
        }

        
        
        function loadData() {
            let data_ = null;
            jQuery.ajax({
                url: ajaxUrl + '?fun=voli&oper=getAllSequenceByViaggio',
                type: 'POST',
                data: {
                    id_andata: id_andata,
                    id_ritorno: id_ritorno,
                    seq_andata: seq_andata,
                    seq_ritorno: seq_ritorno
                },
                dataType: "json",
                async: false,
                success: function (data) {

                    var parsedResult = checkAjaxResponse(data, false);
                    if (!parsedResult) {

                        data_ = data;

                    }
                }
            });

            return data_;
        }

        // Disegna tabs per gli scali
        function drawRouteTabs(travelType, routes) {

            if (routes) {
                const tabs = $("#" + travelType + "Tabs");
                const content = $("#" + travelType + "Content");

                tabs.empty();
                content.empty();

                for (let i = 0; i < routes.length; ++i) {
                    let route = routes[i];
                    let tab_id = travelType + "-route-" + route.id_volo;

                    unique_tratte[`${route.aereoporto_partenza_rel.citta} -> ${route.aereoporto_arrivo_rel.citta}`] = false;

                    tabs.append(`
                            <li class="nav-item" role="presentation">
                              <button class="nav-link ${route.sequence_identifier === 1 ? "active" : ""}" id="${tab_id}-tab"
                                      data-bs-toggle="tab" data-bs-target="#${tab_id}" type="button" role="tab">
                                ${route.aereoporto_partenza_rel.citta} -> ${route.aereoporto_arrivo_rel.citta}
                              </button>
                            </li>
                          `);

                    content.append(`
                            <div class="tab-pane fade ${route.sequence_identifier === 1 ? "show active" : ""}" id="${tab_id}" role="tabpanel">
                              <div id="seatMap-${tab_id}" class=""></div>
                            </div>
                          `);

                    let prices = {}
                    for (let j = 0; j < route.prices.length; j++) {
                        let price = route.prices[j];
                        prices[price.seat_class] = price;
                    }

                    drawSeatMap(
                        cabins,
                        $("#seatMap-" + tab_id),
                        travelType,
                        `${route.aereoporto_partenza_rel.citta} -> ${route.aereoporto_arrivo_rel.citta}`,
                        {
                            "FirstClass": [route.aereo_rel.seat_row_number_first, route.aereo_rel.seat_column_number_first],
                            "Business": [route.aereo_rel.seat_row_number_business, route.aereo_rel.seat_column_number_business],
                            "Economy": [route.aereo_rel.seat_row_number_economy, route.aereo_rel.seat_column_number_economy]
                        },
                        route.seats,
                        prices,
                        route
                    )
                }
            }

        }

        // Disegna mappa dei posti (accordion per cabine)
        function drawSeatMap(cabins, seatMap, travelType, route, map, seats, prices,volo_raw_data) {
            const routeId = route.replace(/\s/g, '').replace(/[^a-zA-Z0-9_-]/g, '');
            let lastClassSeen = null;
            let seatContainer = null;
            let rowId = "";
            let changed_class = false;
            let inserted = 0;

            seatMap.empty();
            seatMap.append(`<div class="accordion" id="accordion_${routeId}"></div>`);
            const accordionParent = $(`#accordion_${routeId}`);

            // Helper: get color class for seat class
            function getClassColorClass(seatClass) {
                switch (seatClass.toLowerCase()) {
                    case "economy": return "economy";
                    case "business": return "business";
                    case "first": return "first";
                    default: return "";
                }
            }

            // Loop through seats
            for (let i = 0; i < seats.length; i++) {
                const seat = seats[i];
                const seatClass = seat.seat_class;

                if (lastClassSeen !== seatClass) {
                    changed_class = true;
                    lastClassSeen = seatClass;
                    const idx = `${routeId}_${seatClass}`;
                    const classColor = getClassColorClass(seatClass);

                    const itemHtml = `
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading_${idx}">
                                    <button class="accordion-button collapsed ${classColor}" type="button"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#collapse_${idx}"
                                            aria-expanded="false"
                                            aria-controls="collapse_${idx}">
                                        ${route} - ${seatClass}
                                    </button>
                                </h2>
                                <div id="collapse_${idx}" class="accordion-collapse collapse"
                                     aria-labelledby="heading_${idx}"
                                     data-bs-parent="#accordion_${routeId}">
                                    <div class="accordion-body" id="${idx}_seats"></div>
                                </div>
                            </div>
                        `;
                    accordionParent.append(itemHtml);
                    seatContainer = $(`#${idx}_seats`);
                }

                const [rows, cols] = map[seatClass];

                // Start new row
                if (inserted % cols === 0 || changed_class) {
                    inserted = 0;
                    changed_class = false;
                    rowId = `${routeId}_${seatClass}_row_${i}`;
                    const rowHtml = `
                            <div class="seat-row d-flex align-items-center mb-2" id="${rowId}">
                                <div class="seat-group d-flex flex-wrap" id="${rowId}_col_1"></div>
                                <div class="aisle text-center col-2">||</div>
                                <div class="seat-group d-flex flex-wrap" id="${rowId}_col_2"></div>
                            </div>
                        `;
                    seatContainer.append(rowHtml);
                }

                // Determine left/right column
                const colIndex = inserted % cols;
                const targetCol = colIndex < cols / 2
                    ? $(`#${rowId}_col_1`)
                    : $(`#${rowId}_col_2`);

                // Create seat element
                const seatId = `${travelType}-${route}-${seatClass}-${seat.seat_label}`;
                const seatDiv = $(`
                        <div class="seat ${seat.posti_occupati ? 'occupied' : 'free'} p-1 text-center" id="${seatId}">
                            <div class="d-flex flex-column justify-content-center align-items-center seat-content">
                              <div class="seat-label fw-bold">${seat.seat_label}</div>
                              <div class="seat-price text-muted small">${prices[seatClass].costo_posto} €</div>
                            </div>
                          </div>
                    `);
                targetCol.append(seatDiv);

                // Add seat info
                seatDiv.data("info", {
                    travelType,
                    route,
                    cabin: seatClass,
                    seat: seat.seat_label,
                    price: prices[seatClass].costo_posto,
                    volo_raw_data:volo_raw_data
                });

                // Seat click behavior
                seatDiv.on("click", function () {

                    if ($(this).hasClass("occupied")) return;


                    const info = $(this).data("info");

                    if ($(this).hasClass("selected"))
                    {
                        unique_tratte[info.route] = false;
                        selectedSeats = selectedSeats.filter(s => !(s.travelType === info.travelType && s.route === info.route && s.cabin === info.cabin && s.seat === info.seat));
                        $(this).toggleClass("selected");
                        updateSummary();
                        return;
                    }


                    // si può fare meglio -------------
                    let counting_unique_ticket = {};

                    for (let i = 0; i < selectedSeats.length; i++) {
                        let route = selectedSeats[i].route;
                        if (!counting_unique_ticket[route]) {
                            counting_unique_ticket[route] = 1; // start at 1
                        } else {
                            counting_unique_ticket[route]++; // increment
                        }
                    }

                    counting_unique_ticket[info.route]++;

                    let errors_encountered = false;

                    for (const [route, count] of Object.entries(counting_unique_ticket)) {
                        if (count > parseInt(quantity)) {
                            errors_encountered = true;
                        }
                    }

                    if (errors_encountered) {
                        showToast("Numero di biglietti selezionati eccede la quantità proposta.")
                        return;
                    }



                    // ----------------------

                    $(this).toggleClass("selected");


                    if ($(this).hasClass("selected")) {
                        selectedSeats.push(info);
                    }

                    unique_tratte[info.route] = true;

                    updateSummary();
                });
                inserted++;
            }
        }



        // Aggiorna riepilogo
        function updateSummary() {
            $("#quantita").text(selectedSeats.length);

            $("#selectedSeatDisplay").text(
                selectedSeats.map(s => `${s.route} [${s.seat}]`).join(", ") || "-"
            );

            // Ensure numeric sum
            let total = selectedSeats.reduce((sum, s) => sum + Number(s.price || 0) - Number(s.price || 0) * viaggio_local_data[s.travelType].sconto_biglietto, 0);

            // Format total as integer or with 2 decimals
            $("#totalPriceDisplay").text(total.toFixed(2) + " €");

            let show_confirm = true;
            for([key,value] of Object.entries(unique_tratte))
            {
                show_confirm &&= value;
            }

            if (show_confirm)
            {
                $('#conferma_prenotazione').removeClass('d-none');
                $('#warning_tratte').addClass('d-none');
            }
            else
            {
                $('#conferma_prenotazione').addClass('d-none');
                $('#warning_tratte').removeClass('d-none');
            }

        }

        function updateSummaryModal() {
            $("#quantitaModal").text(selectedSeats.length);

            $("#selectedSeatDisplayModal").text(
                selectedSeats.map(s => `${s.route} [${s.seat}]`).join(", ") || "-"
            );

            let total = selectedSeats.reduce((sum, s) => sum + Number(s.price || 0) - Number(s.price || 0) * viaggio_local_data[s.travelType].sconto_biglietto, 0);

            // Format total as integer or with 2 decimals
            $("#totalPriceDisplayModal").text(total.toFixed(2)  + " €");

            $("#checkoutButton").on('click', () => {
                PrenotaClass.checkout();
            });


        }

        return {
            init() {

                params = new URLSearchParams(window.location.search);
                id_andata = params.get("id_andata");
                id_ritorno = params.get("id_ritorno");

                getViaggioData();

                quantity = params.get("quantita");
                seq_andata = params.get("seq_andata");
                seq_ritorno = params.get("seq_ritorno");

                voli_data = loadData();

                drawRouteTabs("andata", voli_data.andata);
                drawRouteTabs("ritorno", voli_data.ritorno);

            },

            confirm() {

                // dovrebbe essere che la quantità ad ogni scalo n
                // devo selezionare tutti i biglietti

                let counting_unique_ticket = {};

                for (let i = 0; i < selectedSeats.length; i++) {
                    let route = selectedSeats[i].route;
                    if (!counting_unique_ticket[route]) {
                        counting_unique_ticket[route] = 1; // start at 1
                    } else {
                        counting_unique_ticket[route]++; // increment
                    }
                }

                for (let i=0; i < selectedSeats.length; i++) {
                    let row = $('<div></div>');
                    row.addClass('row mb-3');
                    let labelHtml = `<label class="form-label">Biglietto ${selectedSeats[i].cabin} posto: ${selectedSeats[i].seat} </label>`;
                    let infoHtml = `
                            <div class="col-md-6">
                                <input type="text" class="form-nome-${i} form-control" placeholder="Inserisci nome" required>
                            </div>
                            <div class="col-md-6">
                                <input type="text" class="form-cognome-${i} form-control" placeholder="Inserisci cognome" required>
                            </div>`;


                    row.append(labelHtml + infoHtml);
                    $('#nominativiContainer').append(row);
                }
                updateSummaryModal();
            },

            checkout() {

                let info = []
                
                for(let i=0; i < selectedSeats.length; i++) {

                    let nome = $(`.form-nome-${i}`).val();
                    let cognome = $(`.form-cognome-${i}`).val();

                    if(nome === '' || cognome === '') {
                        showToast("Errore durante l'acquisto, inserire tutti i nominativi.");
                        return;
                    }

                    info.push({
                        'nome': nome,
                        'cognome': cognome,
                        'cabin': selectedSeats[i].cabin,
                        'seat': selectedSeats[i].seat,
                        'travelType': selectedSeats[i].travelType,
                        'route': selectedSeats[i].route,
                        'volo_raw_data':selectedSeats[i].volo_raw_data,
                        'price':selectedSeats[i].price
                    });
                }


                jQuery.ajax({
                    url: ajaxUrl + '?fun=biglietti&oper=checkout',
                    type: 'POST',
                    dataType: "json",
                    data: {
                        id_andata:id_andata,
                        id_ritorno:id_ritorno,
                        quantity:quantity,
                        info: JSON.stringify(info)
                    },
                    async: true,
                    success: function (data) {
                        errorModal.hide();
                        var parsedResult = checkAjaxResponse(data, false);
                        if (!parsedResult) {
                            var result = data
                            showToast('Acquisto avvennuto con successo.');
                            document.location.href = "/mytriviaggi"
                        } else {
                            setTimeout(function () {
                                showError('Errore', 'Attenzione, transazione negata.', '<button class="btn btn-light" data-bs-dismiss="modal" onclick="errorModal.hide();PACompagniaAereaAddModal.errorModal();" type="button">Chiudi</button>', true);
                            }, 500);
                        }
                    }
                });
            }

        }
    }();


    // Inizializza pagina
    $(function () {
        PrenotaClass.init();
    });
</script>

</script>
{% endblock extra_jquery %}

{% block main_content %}

<div class="container py-4">

    <!-- Tabs principali Andata/Ritorno -->
    <ul class="nav nav-tabs" id="tripTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="andata-tab" data-bs-toggle="tab" data-bs-target="#andata" type="button"
                role="tab">
                Andata
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="ritorno-tab" data-bs-toggle="tab" data-bs-target="#ritorno" type="button"
                role="tab">
                Ritorno
            </button>
        </li>
    </ul>

    <div class="tab-content mt-3">
        <!-- ANDATA -->
        <div class="tab-pane fade show active" id="andata" role="tabpanel">
            <ul class="nav nav-tabs" id="andataTabs" role="tablist"></ul>
            <div class="tab-content mt-3" id="andataContent"></div>
        </div>

        <!-- RITORNO -->
        <div class="tab-pane fade" id="ritorno" role="tabpanel">
            <ul class="nav nav-tabs" id="ritornoTabs" role="tablist"></ul>
            <div class="tab-content mt-3" id="ritornoContent"></div>
        </div>
    </div>

    <!-- Riepilogo -->
    <div class="card shadow-sm mt-4">
        <div class="card-body">
            <h5 class="text-primary mb-3">Riepilogo</h5>
            <div class="row">
                <div class="col-md-3">
                    <small>Biglietti</small>
                    <div id="quantita" class="h6">0</div>
                </div>
                <div class="col-md-3">
                    <small>Posti Selezionati</small>
                    <div id="selectedSeatDisplay" class="h6 text-success">-</div>
                </div>
                <div class="col-md-3">
                    <small>Sconti Applicati</small>
                    <span>Andata:<div id="scontoAndataDisplay" class="h5 text-warning">0</div></span>
                    <span>Ritorno:<div id="scontoRitornoDisplay" class="h5 text-warning">0</div></span>
                </div>

                <div class="col-md-3">
                    <small>Totale</small>
                    <div id="totalPriceDisplay" class="h5 text-warning">0 €</div>
                </div>
            </div>

            <!-- Bottone di conferma -->
            <div class="row mt-4">
                <div class="col-12 text-center">
                    <button onclick="PrenotaClass.confirm()" type="button" class="btn btn-success btn-lg px-4 d-none"
                        data-bs-toggle="modal" data-bs-target="#nominativiModal" id="conferma_prenotazione">
                        Conferma Prenotazione
                    </button>

                    <span id="warning_tratte" >Seleziona i posti per tutte le tratte da effettuare</span>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Modal per inserimento nominativi -->
<div class="modal fade" id="nominativiModal" tabindex="-1" aria-labelledby="nominativiModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="nominativiModalLabel">Inserisci Nominativi</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    Inserisci i nominativi per tutti i biglietti selezionati
                </div>

                <!-- Form per i nominativi -->
                <form id="nominativiForm">
                    <div id="nominativiContainer"></div>

                    <hr>

                    <!-- Riepilogo nell'ordine -->
                    <div class="bg-light p-3 rounded">
                        <h6 class="text-primary mb-2">Riepilogo Ordine</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <small>Biglietti</small>
                                <div id="quantitaModal" class="h6">0</div>
                            </div>
                            <div class="col-md-4">
                                <small>Posti Selezionati</small>
                                <strong id="selectedSeatDisplayModal" class="h6 text-success">-</strong>
                            </div>
                            <div class="col-md-4">
                                <small>Totale ( con applicato sconto )</small>
                                <strong id="totalPriceDisplayModal" class="h5 text-warning">0 €</strong>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button onclick="clearModal()" type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button id="checkoutButton" type="button" class="btn btn-success">
                    <i class="fas fa-check me-2"></i>
                    Conferma e Paga
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock main_content %}