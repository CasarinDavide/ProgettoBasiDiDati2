{% extends "base.html" %}

{% block title %}
{% if user %}
Home - {{ user }}
{% else %}
Home
{% endif %}
{% endblock title %}

{% block extra_css %}

{% endblock extra_css %}

{% block extra_jquery %}

    <style>

        .accordion-button.economy {
            background-color: #4caf50; /* Green */
            color: white;
        }

        .accordion-button.business {
            background-color: #f44336; /* Red */
            color: white;
        }

        .accordion-button.first {
            background-color: #2196f3; /* Blue */
            color: black;
        }

        /* Seat map background */
        .accordion-body {
            background-color: #f5f5f5;
        }

        /* Seat improvements */
        .seat-row {
            width: 100%;
        }

        .seat-group {
            display: flex;
            gap: 5px;
        }

        .aisle {
            width: 20px;
        }

        .seat {
            width: 35px;
            height: 35px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            cursor: pointer;
            border: 1px solid #ccc;
            transition: 0.2s all;
        }

        .seat.free { background-color: #e0f7fa; }
        .seat.occupied { background-color: #b0bec5; cursor: not-allowed; }
        .seat.selected { background-color: #4db6ac; color: white; }

        .seat-row {
            width: 100%;
        }

        .seat-group {
            display: flex;
            gap: 5px; /* space between seats */
        }

        .aisle {
            width: 20px; /* narrow aisle */
        }

        .seat {
            width: 35px;
            height: 35px;
            border-radius: 5px;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            cursor: pointer;
            border: 1px solid #ccc;
            transition: 0.2s all;
        }

        .seat.free {
            background-color: #e0f7fa;
        }

        .seat.occupied {
            background-color: #b0bec5;
            cursor: not-allowed;
        }

        .seat.selected {
            background-color: #4db6ac;
            color: white;
        }
    </style>

    <script>


        let PrenotaClass = function(){

            const cabins =  ["FirstClass", "Business", "Economy"]

            let params;
            let id_andata;
            let id_ritorno;
            let quantity;
            let seq_ritorno;
            let seq_andata;
            let selectedSeats = [];
            let viaggio_data;

            function loadData(){
                let data_ = null;
                jQuery.ajax({
                    url: ajaxUrl + '?fun=voli&oper=getAllSequenceByViaggio',
                    type: 'POST',
                    data: {
                        id_andata:id_andata,
                        id_ritorno:id_ritorno,
                        seq_andata:seq_andata,
                        seq_ritorno:seq_ritorno
                    },
                    dataType: "json",
                    async: false,
                    success: function (data) {

                        var parsedResult = checkAjaxResponse(data, false);
                        if (!parsedResult) {

                            data_ = data;

                        }
                    }
                });

                return data_;
            }

            // Disegna tabs per gli scali
            function drawRouteTabs(travelType, routes) {

                if(routes)
                {
                    const tabs = $("#" + travelType + "Tabs");
                    const content = $("#" + travelType + "Content");

                    tabs.empty();
                    content.empty();

                    for(let i = 0; i < routes.length;++i)
                    {
                        let route = routes[i];
                        let tab_id = travelType + "-route-" + route.id_volo;

                        tabs.append(`
                            <li class="nav-item" role="presentation">
                              <button class="nav-link ${route.sequence_identifier === 1 ? "active" : ""}" id="${tab_id}-tab"
                                      data-bs-toggle="tab" data-bs-target="#${tab_id}" type="button" role="tab">
                                ${route.aereoporto_partenza_rel.citta} -> ${route.aereoporto_arrivo_rel.citta}
                              </button>
                            </li>
                          `);

                        content.append(`
                            <div class="tab-pane fade ${route.sequence_identifier === 1 ? "show active" : ""}" id="${tab_id}" role="tabpanel">
                              <div id="seatMap-${tab_id}" class=""></div>
                            </div>
                          `);

                        let prices = {}
                        for(let j = 0; j < route.prices.length; j++)
                        {
                            let price = route.prices[j];
                            prices[price.seat_class] = price;
                        }

                        drawSeatMap(
                            cabins,
                            $("#seatMap-" + tab_id),
                            travelType,
                            `${route.aereoporto_partenza_rel.citta} -> ${route.aereoporto_arrivo_rel.citta}`,
                            {
                                "FirstClass": [route.aereo_rel.seat_row_number_first,route.aereo_rel.seat_column_number_first],
                                "Business": [route.aereo_rel.seat_row_number_business,route.aereo_rel.seat_column_number_business],
                                "Economy": [route.aereo_rel.seat_row_number_economy,route.aereo_rel.seat_column_number_economy]
                            },
                            route.seats,
                            prices
                        )
                    }
                }

            }

            // Disegna mappa dei posti (accordion per cabine)
           function drawSeatMap(cabins, seatMap, travelType, route, map, seats,prices) {
                const routeId = route.replace(/\s/g, '').replace(/[^a-zA-Z0-9_-]/g, '');
                let lastClassSeen = null;
                let seatContainer = null;
                let rowId = "";
                let changed_class = false;
                let inserted = 0;

                seatMap.empty();
                seatMap.append(`<div class="accordion" id="accordion_${routeId}"></div>`);
                const accordionParent = $(`#accordion_${routeId}`);

                // Helper: get color class for seat class
                function getClassColorClass(seatClass) {
                    switch(seatClass.toLowerCase()) {
                        case "economy": return "economy";
                        case "business": return "business";
                        case "first": return "first";
                        default: return "";
                    }
                }

                // Loop through seats
                for (let i = 0; i < seats.length; i++) {
                    const seat = seats[i];
                    const seatClass = seat.seat_class;

                    if (lastClassSeen !== seatClass) {
                        changed_class = true;
                        lastClassSeen = seatClass;
                        const idx = `${routeId}_${seatClass}`;
                        const classColor = getClassColorClass(seatClass);

                        const itemHtml = `
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading_${idx}">
                                    <button class="accordion-button collapsed ${classColor}" type="button"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#collapse_${idx}"
                                            aria-expanded="false"
                                            aria-controls="collapse_${idx}">
                                        ${route} - ${seatClass}
                                    </button>
                                </h2>
                                <div id="collapse_${idx}" class="accordion-collapse collapse"
                                     aria-labelledby="heading_${idx}"
                                     data-bs-parent="#accordion_${routeId}">
                                    <div class="accordion-body" id="${idx}_seats"></div>
                                </div>
                            </div>
                        `;
                        accordionParent.append(itemHtml);
                        seatContainer = $(`#${idx}_seats`);
                    }

                    const [rows, cols] = map[seatClass];

                    // Start new row
                    if (inserted % cols === 0 || changed_class) {
                        inserted = 0;
                        changed_class = false;
                        rowId = `${routeId}_${seatClass}_row_${i}`;
                        const rowHtml = `
                            <div class="seat-row d-flex align-items-center mb-2" id="${rowId}">
                                <div class="seat-group d-flex flex-wrap" id="${rowId}_col_1"></div>
                                <div class="aisle text-center col-2">||</div>
                                <div class="seat-group d-flex flex-wrap" id="${rowId}_col_2"></div>
                            </div>
                        `;
                        seatContainer.append(rowHtml);
                    }

                    // Determine left/right column
                    const colIndex = inserted % cols;
                    const targetCol = colIndex < cols / 2
                        ? $(`#${rowId}_col_1`)
                        : $(`#${rowId}_col_2`);

                    // Create seat element
                    const seatId = `${travelType}-${route}-${seatClass}-${seat.seat_label}`;
                    const seatDiv = $(`
                        <div class="seat ${seat.posti_occupati ? 'occupied' : 'free'}" id="${seatId}">
                            ${seat.seat_label}
                        </div>
                    `);
                    targetCol.append(seatDiv);

                    // Add seat info
                    seatDiv.data("info", {
                        travelType,
                        route,
                        cabin: seatClass,
                        seat: seat.seat_label,
                        price: prices[seatClass].costo_posto
                    });

                    // Seat click behavior
                    seatDiv.on("click", function() {
                        if ($(this).hasClass("occupied")) return;
                        $(this).toggleClass("selected");
                        const info = $(this).data("info");

                        if ($(this).hasClass("selected")) {
                            selectedSeats.push(info);
                        } else {
                            selectedSeats = selectedSeats.filter(s => !(s.travelType === info.travelType && s.route === info.route && s.cabin === info.cabin && s.seat === info.seat));
                        }
                        updateSummary();
                    });
                    inserted++;
                }
            }



            // Aggiorna riepilogo
           function updateSummary() {
                $("#quantita").text(selectedSeats.length);

                $("#selectedSeatDisplay").text(
                    selectedSeats.map(s => `${s.route} [${s.seat}]`).join(", ") || "-"
                );

                // Ensure numeric sum
                let total = selectedSeats.reduce((sum, s) => sum + Number(s.price || 0), 0);

                // Format total as integer or with 2 decimals
                $("#totalPriceDisplay").text(total.toFixed(2) + " €");
           }

           return {
                init(){

                    params = new URLSearchParams(window.location.search);
                    id_andata = params.get("id_andata");
                    id_ritorno = params.get("id_ritorno");
                    quantity = params.get("quantita");
                    seq_andata = params.get("seq_andata");
                    seq_ritorno = params.get("seq_ritorno");

                    viaggio_data = loadData();

                    drawRouteTabs("andata", viaggio_data.andata);
                    drawRouteTabs("ritorno", viaggio_data.ritorno);

                }

            }
        }();

        // Fake data



        // Inizializza pagina
        $(function() {
            PrenotaClass.init();
        });
    </script>

</script>
{% endblock extra_jquery %}

{% block main_content %}

    <div class="container py-4">

        <!-- Tabs principali Andata/Ritorno -->
        <ul class="nav nav-tabs" id="tripTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="andata-tab" data-bs-toggle="tab" data-bs-target="#andata" type="button" role="tab">
                    Andata
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ritorno-tab" data-bs-toggle="tab" data-bs-target="#ritorno" type="button" role="tab">
                    Ritorno
                </button>
            </li>
        </ul>

        <div class="tab-content mt-3">
            <!-- ANDATA -->
            <div class="tab-pane fade show active" id="andata" role="tabpanel">
                <ul class="nav nav-tabs" id="andataTabs" role="tablist"></ul>
                <div class="tab-content mt-3" id="andataContent"></div>
            </div>

            <!-- RITORNO -->
            <div class="tab-pane fade" id="ritorno" role="tabpanel">
                <ul class="nav nav-tabs" id="ritornoTabs" role="tablist"></ul>
                <div class="tab-content mt-3" id="ritornoContent"></div>
            </div>
        </div>

        <!-- Riepilogo -->
        <div class="card shadow-sm mt-4">
            <div class="card-body">
                <h5 class="text-primary mb-3">Riepilogo</h5>
                <div class="row">
                    <div class="col-md-4">
                        <small>Biglietti</small>
                        <div id="quantita" class="h6">0</div>
                    </div>
                    <div class="col-md-4">
                        <small>Posti Selezionati</small>
                        <div id="selectedSeatDisplay" class="h6 text-success">-</div>
                    </div>
                    <div class="col-md-4">
                        <small>Totale ( senza sconto )</small>
                        <div id="totalPriceDisplay" class="h5 text-warning">0 €</div>

                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock main_content %}