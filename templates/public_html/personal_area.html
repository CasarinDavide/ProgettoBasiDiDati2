{% extends "base.html" %}

{% block title %}
MyTriviaggi
{% endblock title %}

{% block extra_jquery %}

<script>

    class UserClass {
        constructor(data) {
            this.nome = data.nome;
            this.cognome = data.cognome;
            this.nascita = data.nascita;
            this.email = data.email;
            this.telefono = data.tel;
            this.civico = data.civico;
            this.via = data.via;
            this.citta = data.citta;
            this.cod_postale = data.cod_postale;
            this.paese = data.paese;
        }

        setValue(newValue, field, subfield = null,) {
            let selector = `[data-field='${field}'] .form-control`;
            if (subfield)
                selector += `[data-subfield='${subfield}']`;

            $(selector).text(newValue);
        }

        fill() {
            this.setValue(this.nome, 'nome_cognome', 'nome');
            this.setValue(this.cognome, 'nome_cognome', 'cognome');
            this.setValue(this.nascita, 'data_nascita');
            this.setValue(this.email, 'email');
            this.setValue(this.telefono, 'telefono');

            this.setValue(this.civico, 'indirizzo', 'civico');
            this.setValue(this.via, 'indirizzo', 'via');
            this.setValue(this.citta, 'indirizzo', 'citta');
            this.setValue(this.cod_postale, 'indirizzo', 'cod_postale');
            this.setValue(this.paese, 'indirizzo', 'paese');
        }

    }

    class ViaggioClass {
        constructor(data) {
            this.idViaggio = data.id_viaggio;
            this.partenza = new Date(data.partenza);
            this.durata = parseInt(data.durata) * 6000; //ms
            this.arrivo = new Date(this.partenza.getTime() + this.durata);
            //TODO capire come gestire sosta e numero di scali
            this.scaduto = data.scaduto ? 'scaduto' : 'valido';
            this.aereoporti = data.partenza_destinazione;

            this.voli = Object.values(data.voli).map(volo => new VoloClass(volo));
        }

        render(container) {
            let viaggio = document.createElement('div')
            viaggio.className = `${this.idViaggio} row ${this.scaduto}`;
            viaggio.innerHTML = `
                <div class="col-12 mb-10">
                    <div class="card shadow-lg border-0">
                        <div class="card-body p-4">
                            <!-- Header Viaggio -->
                            <div class="d-flex justify-content-between align-items-start mb-4">
                                <div>
                                    <h5 class="card-title mb-2 text-primary">
                                        <i class="fas fa-route me-2"></i>
                                        Viaggio: ${this.aereoporti}
                                    </h5>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-success fs-6 px-3 py-2 mb-2">
                                        <i class="fas fa-check-circle me-1"></i>
                                        ${this.scaduto.toUpperCase()}
                                    </span>
                                </div>
                            </div>

                            <div class="row g-3 mb-4">
                                <div class="col-md-4">
                                    <div class="card bg-light border-0 h-100">
                                        <div class="card-body text-center p-3">
                                            <i class="fas fa-calendar text-success fs-4 mb-2"></i>
                                            <h6 class="text-muted mb-1"> Partenza </h6>
                                            <h6 class="mb-0 fw-bold">${this.partenza.toUTCString()}</h6>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-light border-0 h-100">
                                        <div class="card-body text-center p-3">
                                            <i class="fas fa-clock text-warning fs-4 mb-2"></i>
                                            <h6 class="text-muted mb-1">Durata</h6>
                                            <h5 class="mb-0 fw-bold">${this.durata / 6000} min</h5>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-light border-0 h-100">
                                        <div class="card-body text-center p-3">
                                            <i class="fas fa-plane-arrival text-info fs-4 mb-2"></i>
                                            <h6 class="text-muted mb-1">Scali</h6>
                                            <h5 class="mb-0 fw-bold"> ${this.voli.length} </h5>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="voliContainer" class="accordion">
                            </div>
                        </div>
                    </div>
                </div>`;

            let voliContainer = viaggio.querySelector('#voliContainer');
            this.voli.forEach(volo => { volo.render(voliContainer) });
            container.appendChild(viaggio);
        }
    }

    class VoloClass {
        constructor(data) {
            this.idVolo = data.id_volo;
            this.ordine = data.ordine;
            this.aereoporti = data.aereoporti;

            this.biglietti = data.biglietti.map(b => new BigliettoClass(b));
        }

        render(container) {
            let volo = document.createElement('div');
            volo.className = "accordion-item border-0 shadow-sm mb-3";
            volo.innerHTML = `
                <h2 class="accordion-header" id="headingVolo${this.idVolo}">
                    <button class="accordion-button collapsed bg-primary bg-opacity-10 fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseVolo${this.idVolo}" aria-expanded="false" aria-controls="collapseVolo${this.idVolo}">
                        <i class="fas fa-plane-departure me-3 text-primary"></i>
                        Volo ${this.idVolo}
                    </button>
                </h2>
                <div id="collapseVolo${this.idVolo}" class="accordion-collapse collapse" aria-labelledby="headingVolo${this.idVolo}" data-bs-parent="#voliContainer">
                    <div class="accordion-body p-4">
                        <div class="row mb-4">
                            <div class="col">
                                <div class="card border-primary border-opacity-25">
                                    <div class="card-body">
                                        <h6 class="text-primary mb-2">
                                            <i class="fas fa-route me-2"></i>
                                            Tratta
                                        </h6>
                                        <p class="mb-0"> ${this.aereoporti} </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h6 class="mb-3">
                            <i class="fas fa-users me-2 text-primary"></i>
                            Biglietti
                        </h6>
                        <div id="ticketContainer" class="list-group">
                        </div>
                    </div>
                </div>
            `;
            let ticketContainer = volo.querySelector('#ticketContainer');
            this.biglietti.forEach(ticket => ticket.render(ticketContainer));
            container.appendChild(volo);
        }
    }

    class BigliettoClass {
        constructor(data) {
            this.idBiglietto = data.id_biglietto;
            this.nominativo = data.nominativo;
            this.posto = data.posto;
            this.prezzo = parseFloat(data.prezzo).toFixed(2);
            this.pasto = data.pasto;
            this.internet = data.internet;
            this.bagagli = data.bagagli;
        }

        render(container) {
            let ticket = document.createElement('div');
            ticket.className = "list-group-item d-flex align-items-center shadow-sm border-opacity-50 mb-2 rounded-3";
            ticket.innerHTML = `
                <i class="fas fa-ticket fs-3 me-3"></i>
                <div class="flex-grow-1">
                    <h6 class="mb-0 fw-bold"> ${this.nominativo} </h6>
                    <small class="text-muted">ID biglietto: ${this.idBiglietto} </small>
                </div>

                <div class="mt-3 me-5 mb-3">
                    <small class="d-block ${this.internet ? 'text-success' : 'text-muted'}">
                        <i class="fas fa-wifi me-1"></i> Internet: ${this.internet ? 'Sì' : 'No'}
                    </small>
                    <small class="d-block ${this.pasto ? 'text-success' : 'text-muted'}">
                        <i class="fas fa-utensils me-1"></i> Pasto: ${this.pasto ? 'Sì' : 'No'}
                    </small>
                    <small class="d-block text-muted">
                        <i class="fas fa-suitcase-rolling me-1"></i> Bagagli: ${this.bagagli}
                    </small>
                </div>

                <div class="text-end">
                    <small class="text-muted">Posto</small>
                    <div class="fw-bold text-primary"> ${this.posto} </div>
                </div>
            `;

            container.appendChild(ticket);
        }
    }

    let globalUser = null;
    let globalViaggiCollection = null;

    //Request to get the user information
    $(document).ready(() => {
        $.ajax({
            url: ajaxUrl + "?fun=personalArea&oper=getCurrentInfo",
            type: "POST",
            success: (data) => {
                globalUser = new UserClass(data);
                globalUser.fill();
            }
        })
    });

    //request to get "Viaggi" informations
    $(document).ready(() => {
        $.ajax({
            url: ajaxUrl + "?fun=tickets&oper=getByUser",
            type: "POST",
            success: (data) => {
                if (!data || data.error)
                    return

                Object.entries(data).forEach(([idViaggio, viaggio]) => {
                    let v = new ViaggioClass(viaggio);
                    let container = document.querySelector('#viaggi');

                    console.log(v);
                    console.log(viaggio);

                    v.render(container);
                });

                visualizza('valido', 'scaduto');
            },

            error: (err) => {
                console.log(err)
            }
        })
    });


</script>

{% endblock extra_jquery %}


{% block main_content %}
<script>
    //hide everything except account details
    document.addEventListener("DOMContentLoaded", () => {
        document.getElementById('account').style.display = 'block';
        document.getElementById('viaggi').style.display = 'none';
    });

    function save(field) {
        let container = document.querySelector(`[data-field='${field}'] .input-group`);
        let newValue = "";

        switch (field) {
            case "nome_cognome": {
                const nome = container.querySelector("[data-subfield='nome']").value;
                const cognome = container.querySelector("[data-subfield='cognome']").value;
                newValue = `${nome} ${cognome}`;

                container.innerHTML = `
                    <span class="form-control" data-subfield="nome"> ${nome} </span>
                    <span class="form-control" data-subfield="cognome"> ${cognome} </span>`;
                break;
            }

            case "indirizzo": {
                const civico = container.querySelector("[data-subfield='civico']").value;
                const via = container.querySelector("[data-subfield='via']").value;
                const citta = container.querySelector("[data-subfield='citta']").value;
                const cod_postale = container.querySelector("[data-subfield='cod_postale']").value;
                const paese = container.querySelector("[data-subfield='paese']").value;

                newValue = `${civico} ${via} ${citta} ${cod_postale} ${paese}`;
                container.innerHTML = `
                    <span class="form-control" data-subfield="civico">${civico}</span>
                    <span class="form-control" data-subfield="via">${via}</span>
                    <span class="form-control" data-subfield="citta">${citta}</span>
                    <span class="form-control" data-subfield="cod_postale">${cod_postale}</span>
                    <span class="form-control" data-subfield="paese">${paese}</span>`;
                break;
            }

            default: {
                const value = container.querySelector("input").value;
                newValue = value;
                container.innerHTML = `<span class="form-control">${value}</span>`;
            }
        }

        // reset pulsante "Modifica"
        const oldBtn = document.querySelector(`[data-field='${field}'] .btn`);

        const newBtn = document.createElement("button");
        newBtn.className = "btn btn-link btn-sm mb-2";
        newBtn.setAttribute("onclick", `edit('${field}')`);
        newBtn.textContent = "Modifica";

        oldBtn.replaceWith(newBtn);
        // chiamata AJAX
        $.ajax({
            url: `${ajaxUrl}?fun=personalArea&oper=update&element=${field}&value=${encodeURIComponent(newValue)}`,
            type: "POST"
        });
    }

    function edit(field) {
        let container = document.querySelector(`[data-field='${field}'] .input-group`);

        switch (field) {
            case "nome_cognome":
                container.innerHTML = `
                <input type="text" class="form-control" placeholder="Nome" data-subfield="nome">
                <input type="text" class="form-control" placeholder="Cognome" data-subfield="cognome">
            `;
                break;

            case "data_nascita":
                container.innerHTML = `<input type="date" class="form-control" required>`;
                break;

            case "email":
                container.innerHTML = `<input type="email" class="form-control" placeholder="Email" required>`;
                break;

            case "telefono":
                container.innerHTML = `<input type="tel" class="form-control" placeholder="+39..." required>`;
                break;

            case "password":
                container.innerHTML = `<input type="password" class="form-control" placeholder="Password" required>`;
                break;

            case "indirizzo":
                container.innerHTML = `
                    <input type="text" class="form-control" placeholder="Civico" required data-subfield="civico">
                    <input type="text" class="form-control" placeholder="Via" required data-subfield="via">
                    <input type="text" class="form-control" placeholder="Città" required data-subfield="citta">
                    <input type="number" class="form-control" placeholder="Codice Postale" required data-subfield="cod_postale">
                    <input type="text" class="form-control" placeholder="Paese" required data-subfield="paese">`;
                break;
        }

        // imposta pulsante conferma
        const oldBtn = document.querySelector(`[data-field='${field}'] .btn`);
        console.log(oldBtn);

        const newBtn = document.createElement("button");
        newBtn.className = "btn btn-link btn-sm ms-4";
        newBtn.setAttribute("onclick", `save('${field}')`);
        newBtn.innerHTML = `<i class="fa-solid fa-check"></i>`;

        oldBtn.replaceWith(newBtn);
    }

    function changeFocus(id) {
        let hide = document.getElementsByClassName('window');
        for (el of hide) {
            el.style.display = 'none';
        }

        document.getElementById(id).style.display = 'block';
    }

    function visualizza(classToShow, classToHide) {
        Array.from(document.getElementsByClassName(classToHide)).map(el => {
            el.style.display = 'none';
        });

        Array.from(document.getElementsByClassName(classToShow)).map(el => {
            el.style.display = 'block';
        });
    }
</script>

<div class="container-fluid">
    <div class="row vh-100">

        <!-- Sidebar -->
        <div class="col-md-3 bg-white border-end p-3">
            <h5 class="mb-4">Home</h5>
            <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link" onclick="changeFocus('account')">Il mio account</a></li>
                <li class="nav-item"><a class="nav-link" onclick="changeFocus('viaggi')">I miei biglietti</a></li>
            </ul>
        </div>

        <!-- Il mio Account -->
        <div id="account" class="window col-md-9 p-4">
            <h3>Il mio account</h3>
            <p class="text-muted">Le tue informazioni personali</p>

            <div class="mb-3" data-field="nome_cognome">
                <label class="form-label fw-bold">Nome e cognome</label>
                <div class="d-flex justify-content-between align-items-center">
                    <div class="input-group">
                        <span class="form-control" data-subfield="nome"> - </span>
                        <span class="form-control" data-subfield="cognome"> - </span>
                    </div>
                    <button class="btn btn-link btn-sm ms-2" onclick="edit('nome_cognome')">Modifica</button>
                </div>
            </div>

            <div class="mb-3" data-field="data_nascita">
                <label class="form-label fw-bold">Data di nascita</label>
                <div class="d-flex justify-content-between align-items-center">
                    <div class="input-group">
                        <span class="form-control"> - </span>
                    </div>
                    <button class="btn btn-link btn-sm ms-2" onclick="edit('data_nascita')">Modifica</button>
                </div>
            </div>

            <div class="mb-3" data-field="email">
                <label class="form-label fw-bold">Indirizzo email</label>
                <div class="d-flex justify-content-between align-items-center">
                    <div class="input-group">
                        <span class="form-control"> - </span>
                    </div>
                    <button class="btn btn-link btn-sm ms-2" onclick="edit('email')">Modifica</button>
                </div>
            </div>

            <div class="mb-3" data-field="telefono">
                <label class="form-label fw-bold">Numero di telefono</label>
                <div class="d-flex justify-content-between align-items-center">
                    <div class="input-group">
                        <span class="form-control"> - </span>
                    </div>
                    <button class="btn btn-link btn-sm ms-2" onclick="edit('telefono')">Modifica</button>
                </div>
            </div>

            <div class="mb-3" data-field="password">
                <label class="form-label fw-bold">Password</label>
                <div class="d-flex justify-content-between align-items-center">
                    <div class="input-group">
                        <span class="form-control"> ********** </span>
                    </div>
                    <button class="btn btn-link btn-sm ms-2" onclick="edit('password')">Modifica</button>
                </div>
            </div>

            <div class="mb-3" data-field="indirizzo">
                <label class="form-label fw-bold">Indirizzo</label>
                <div class="d-flex justify-content-between align-items-center">
                    <div class="input-group">
                        <span class="form-control" data-subfield="civico"> - </span>
                        <span class="form-control" data-subfield="via"> - </span>
                        <span class="form-control" data-subfield="citta"> - </span>
                        <span class="form-control" data-subfield="cod_postale"> - </span>
                        <span class="form-control" data-subfield="paese"> - </span>
                    </div>
                    <button class="btn btn-link btn-sm ms-2" onclick="edit('indirizzo')">Modifica</button>
                </div>
            </div>
        </div>

        <div id="viaggi" class="window col-md-9 p-4">
            <h3>I miei biglietti</h3>
            <div class="d-flex justify-content-end mb-4">
                <div class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        Visualizza
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" onclick="visualizza('valido', 'scaduto')">Validi</a></li>
                        <li><a class="dropdown-item" onclick="visualizza('scaduto', 'valido')">Scaduti</a></li>
                    </ul>
                </div>
            </div>
            <p class="text-muted">I tuoi voli prenotati</p>
        </div>
    </div>
</div>
{% endblock main_content %}